// ÁôºÈÄÅÊñáÂ≠óË®äÊÅØÂà∞ LINE
async function sendMessageToLine(lineUserId, messageText) {
  console.log("lineUserId", lineUserId);
  console.log("messageText", messageText);
  try {
    const response = await fetch("https://api.line.me/v2/bot/message/push", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer YgHqOO6dO2qkLoUdqWR/NUxI3iMiabk2wqRXpwZjLHXGeRurKgMOeo1wVECp6lvZWa5YsfRybw4BL5t0hHWhOLH1NZO7XtljEi4ZrIk1XrJU97RMyFK9VaKu7Mwm8zW2jfafQ1OSZICuDQpAuHsZTgdB04t89/1O/w1cDnyilFU=`,
      },
      body: JSON.stringify({
        to: lineUserId,
        messages: [
          {
            type: "text",
            text: messageText,
          },
        ],
      }),
    });

    const data = await response.json();
    if (!response.ok) {
      throw new Error(
        `üö® LINE API ÂõûÊáâÈåØË™§: ${JSON.stringify(data)}, to: ${lineUserId}`
      );
    }
    console.log("‚úÖ LINE ÊñáÂ≠óË®äÊÅØÁôºÈÄÅÊàêÂäü:", data);
  } catch (error) {
    console.log("error", error);
    console.error("‚ùå LINE ÊñáÂ≠óË®äÊÅØÁôºÈÄÅÂ§±Êïó:", error);
  }
}

// ÁôºÈÄÅ Flex Message Âà∞ LINE FOR ÈáçË§áÊéíÁè≠Ë®äÊÅØ
function createDuplicateScheduleFlexMessage({
  title = "ÈáçË§áÊéíÁè≠Ë®äÊÅØ",
  customerName,
}) {
  return {
    type: "bubble",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: title,
          weight: "bold",
          size: "sm",
          color: "#FFFFFF", // ÁôΩËâ≤
        },
      ],
      backgroundColor: "#FF0000", // Á¥ÖËâ≤
    },
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: customerName,
          weight: "bold",
          size: "lg",
          wrap: true,
        },
      ],
    },
  };
}

// ÁôºÈÄÅ Flex Message Âà∞ LINE Ë≤ªÁî®Ê≠∑Âè≤
function createCostHistoryFlexMessage({
  title = "Ë≤ªÁî®Ê≠∑Âè≤",
  customerName,
  url,
  backgroundColor = "#003A8A",
}) {
  return {
    type: "bubble",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: title,
          weight: "bold",
          size: "sm",
          color: "#ffffff",
        },
      ],
      backgroundColor: backgroundColor,
    },
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: customerName,
          weight: "bold",
          size: "lg",
          wrap: true,
        },
      ],
    },
    footer: {
      type: "box",
      layout: "vertical",
      spacing: "sm",
      contents: [
        {
          type: "button",
          action: {
            type: "uri",
            label: "Êü•ÁúãË©≥ÊÉÖ",
            uri: url,
          },
          style: "primary",
          // È†êË®≠ÁÇ∫ËóçËâ≤
          color: "#003A8A",
        },
      ],
    },
  };
}

async function sendFlexMessageToLine(
  lineUserId,
  flexMessage,
  altText = "Á≥ªÁµ±ÈÄöÁü•"
) {
  try {
    // **1. Ê™¢Êü• lineUserId**
    if (!lineUserId || typeof lineUserId !== "string") {
      throw new Error(`‚ùå ÁÑ°ÊïàÁöÑ lineUserId: ${lineUserId}`);
    }

    // **2. ÁôºÈÄÅË´ãÊ±Ç**
    const response = await fetch("https://api.line.me/v2/bot/message/push", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        Authorization: `Bearer ${process.env.NEXT_LINE_CHANNEL_ACCESS_TOKEN}`,
      },
      body: JSON.stringify({
        to: lineUserId,
        messages: [
          {
            type: "flex",
            altText: altText,
            contents: flexMessage,
          },
        ],
      }),
    });

    const data = await response.json();

    // **3. ÊâãÂãïÊ™¢Êü• LINE API ÊòØÂê¶ÂõûÂÇ≥ÈåØË™§**
    if (!response.ok) {
      throw new Error(
        `üö® LINE API ÂõûÊáâÈåØË™§: ${JSON.stringify(data)}, to: ${lineUserId}`
      );
    }

    console.log("‚úÖ LINE Flex Message ÁôºÈÄÅÊàêÂäü:", data);
  } catch (error) {
    console.error("‚ùå LINE Flex Message ÁôºÈÄÅÂ§±Êïó:", error);

    // **4. ÈÄöÁü•ÁÆ°ÁêÜÂì°**
    try {
      await sendMessageToLine(
        "Uecdf4fca645f80c191efde218eb123b1", // ‰Ω†ÁöÑÁÆ°ÁêÜÂì° LINE ID
        `‚ùå LINE Flex Message Â§±Êïó: ${error.message}, 
        Áî®Êà∂ ID: ${lineUserId}, 
        Â∞àÊ°àÂêçÁ®±: ${JSON.stringify(flexMessage).customerName || "Êú™Áü•"}`
      );
    } catch (notifyError) {
      console.error("‚ùå ÁÑ°Ê≥ïÈÄöÁü•ÁÆ°ÁêÜÂì°:", notifyError);
    }
  }
}

// format date (2025-02-28T14:00:00.000+08:00) -> 2025/02/28 14:00
function formatDate(dateString) {
  const date = new Date(dateString);

  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, "0");
  const day = String(date.getDate()).padStart(2, "0");
  const hours = String(date.getHours()).padStart(2, "0");
  const minutes = String(date.getMinutes()).padStart(2, "0");

  return `${year}/${month}/${day} ${hours}:${minutes}`;
}

// Âª∫Á´ãÂ∞àÊ°àÈÄöÁü•ÁöÑ Flex Message
function createProjectNotificationFlex({
  title = "Â∞àÊ°àÈÄöÁü•",
  customerName,
  projectType,
  date,
  location,
  url,
  updatedBy,
  backgroundColor = "#003A8A",
}) {
  return {
    type: "bubble",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: title,
          weight: "bold",
          size: "sm",
          color: "#ffffff",
        },
      ],
      backgroundColor: backgroundColor,
    },
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: customerName,
          weight: "bold",
          size: "lg",
          wrap: true,
        },
        {
          type: "box",
          layout: "vertical",
          margin: "lg",
          spacing: "sm",
          contents: [
            {
              type: "box",
              layout: "baseline",
              spacing: "sm",
              contents: [
                {
                  type: "text",
                  text: "È°ûÂûã",
                  color: "#aaaaaa",
                  size: "sm",
                  flex: 1,
                },
                {
                  type: "text",
                  text: projectType || "Êú™Ë®≠ÂÆö",
                  wrap: true,
                  size: "sm",
                  color: "#666666",
                  flex: 4,
                },
              ],
            },
            {
              type: "box",
              layout: "baseline",
              spacing: "sm",
              contents: [
                {
                  type: "text",
                  text: "Êó•Êúü",
                  color: "#aaaaaa",
                  size: "sm",
                  flex: 1,
                },
                {
                  type: "text",
                  text: date || "Êú™Ë®≠ÂÆö",
                  wrap: true,
                  size: "sm",
                  color: "#666666",
                  flex: 4,
                },
              ],
            },
            {
              type: "box",
              layout: "baseline",
              spacing: "sm",
              contents: [
                {
                  type: "text",
                  text: "Âú∞Èªû",
                  color: "#aaaaaa",
                  size: "sm",
                  flex: 1,
                },
                {
                  type: "text",
                  text: location || "Êú™Ë®≠ÂÆö",
                  wrap: true,
                  size: "sm",
                  color: "#666666",
                  flex: 4,
                },
              ],
            },
          ],
        },
        {
          type: "text",
          text: `${updatedBy}`,
          size: "sm",
          color: "#aaaaaa",
          margin: "xxl",
        },
      ],
    },
    footer: {
      type: "box",
      layout: "vertical",
      spacing: "sm",
      contents: [
        {
          type: "button",
          action: {
            type: "uri",
            label: "Êü•ÁúãË©≥ÊÉÖ",
            uri: url,
          },
          style: "primary",
          // È†êË®≠ÁÇ∫ËóçËâ≤
          color: "#003A8A",
        },
      ],
    },
  };
}

// Âª∫Á´ã‰∫∫Âì°Êñ∞Â¢ûÔºàË≤ªÁî®ÔºâÈÄöÁü•ÁöÑ Flex Message
function createCostNotificationFlex({
  title = "‰∫∫Âì°Êñ∞Â¢ûÔºàË≤ªÁî®ÔºâÈÄöÁü•",
  customerName,
  projectType,
  date,
  location,
  url,
  role,
  updatedBy,
  backgroundColor = "#003A8A",
}) {
  return {
    type: "bubble",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: title,
          weight: "bold",
          size: "sm",
          color: "#ffffff",
        },
      ],
      backgroundColor: backgroundColor,
    },
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: customerName,
          weight: "bold",
          size: "lg",
          wrap: true,
        },
        {
          type: "box",
          layout: "vertical",
          margin: "lg",
          spacing: "sm",
          contents: [
            {
              type: "box",
              layout: "baseline",
              spacing: "sm",
              contents: [
                {
                  type: "text",
                  text: "È°ûÂûã",
                  color: "#aaaaaa",
                  size: "sm",
                  flex: 1,
                },
                {
                  type: "text",
                  text: projectType || "Êú™Ë®≠ÂÆö",
                  wrap: true,
                  size: "sm",
                  color: "#666666",
                  flex: 4,
                },
              ],
            },
            {
              type: "box",
              layout: "baseline",
              spacing: "sm",
              contents: [
                {
                  type: "text",
                  text: "Êó•Êúü",
                  color: "#aaaaaa",
                  size: "sm",
                  flex: 1,
                },
                {
                  type: "text",
                  text: formatDate(new Date(date)) || "Êú™Ë®≠ÂÆö",
                  wrap: true,
                  size: "sm",
                  color: "#666666",
                  flex: 4,
                },
              ],
            },
            {
              type: "box",
              layout: "baseline",
              spacing: "sm",
              contents: [
                {
                  type: "text",
                  text: "Âú∞Èªû",
                  color: "#aaaaaa",
                  size: "sm",
                  flex: 1,
                },
                {
                  type: "text",
                  text: location || "Êú™Ë®≠ÂÆö",
                  wrap: true,
                  size: "sm",
                  color: "#666666",
                  flex: 4,
                },
              ],
            },
            {
              type: "text",
              text: `ÊÇ®ÁöÑËßíËâ≤Ôºö${role}`,
              size: "sm",
              color: "#aaaaaa",
              margin: "xxl",
            },
          ],
        },
      ],
    },
    footer: {
      type: "box",
      layout: "vertical",
      spacing: "sm",
      contents: [
        {
          type: "button",
          action: {
            type: "uri",
            label: "Êü•ÁúãË©≥ÊÉÖ",
            uri: url,
          },
          style: "primary",
        },
      ],
    },
  };
}

// Âª∫Á´ãÂÖßÈÉ®Ë°åÂâçÊúÉË≠∞ÈÄöÁü•ÁöÑ Flex Message(Á¢∫Ë™çÂèÉÂä†)
function createInternalPreMeetingNotificationForConfirmFlex({
  title = "ÂÖßÈÉ®Ë°åÂâçÊúÉË≠∞ÈÄöÁü•",
  customerName,
  date,
  location,
  projectType,
  url,
  updatedBy,
  backgroundColor = "#FFE135", // ÈªÉËâ≤
  pageId,
}) {
  return {
    type: "bubble",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: title,
          weight: "bold",
          size: "sm",
          color: "#ffffff",
        },
      ],
      backgroundColor: backgroundColor,
    },
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: customerName,
          weight: "bold",
          size: "lg",
          wrap: true,
        },
        {
          type: "box",
          layout: "vertical",
          margin: "lg",
          spacing: "sm",
          contents: [
            {
              type: "box",
              layout: "baseline",
              spacing: "sm",
              contents: [
                {
                  type: "text",
                  text: "Êó•Êúü",
                  color: "#aaaaaa",
                  size: "sm",
                  flex: 1,
                },
                {
                  type: "text",
                  text: date || "Êú™Ë®≠ÂÆö",
                  wrap: true,
                  size: "sm",
                  color: "#666666",
                  flex: 4,
                },
              ],
            },
          ],
        },
        {
          type: "text",
          text: `${updatedBy || "Á≥ªÁµ±ÈÄöÁü•"}`,
          size: "sm",
          color: "#aaaaaa",
          margin: "xxl",
        },
      ],
    },
    footer: {
      type: "box",
      layout: "vertical",
      spacing: "sm",
      contents: [
        {
          type: "button",
          action: {
            type: "postback",
            label: "Á¢∫Ë™çÂèÉÂä†",
            data: `action=confirm&pageId=${pageId}`,
            displayText: "ÊàëÁ¢∫Ë™çÂèÉÂä†Ê≠§ÊúÉË≠∞",
          },
          style: "primary",
          // Á∂†Ëâ≤
          color: "#008000",
        },
      ],
    },
  };
}
// Âª∫Á´ãÂÖßÈÉ®Ë°åÂâçÊúÉË≠∞ÈÄöÁü•ÁöÑ Flex Message(meet&&ÂÖßÈÉ®ÊµÅÁ®ã)
function createInternalPreMeetingNotificationForMeetAndInternalProcessFlex({
  title = "ÂÖßÈÉ®Ë°åÂâçÊúÉË≠∞ÈÄöÁü•",
  customerName,
  date,
  location,
  projectType,
  url,
  updatedBy,
  backgroundColor = "#FF5733", // Ê©òËâ≤
  innerPageUrl,
}) {
  return {
    type: "bubble",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: title,
          weight: "bold",
          size: "sm",
          color: "#ffffff",
        },
      ],
      backgroundColor: backgroundColor,
    },
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: customerName,
          weight: "bold",
          size: "lg",
          wrap: true,
        },
        {
          type: "box",
          layout: "vertical",
          margin: "lg",
          spacing: "sm",
          contents: [
            {
              type: "box",
              layout: "baseline",
              spacing: "sm",
              contents: [
                {
                  type: "text",
                  text: "Êó•Êúü",
                  color: "#aaaaaa",
                  size: "sm",
                  flex: 1,
                },
                {
                  type: "text",
                  text: date || "Êú™Ë®≠ÂÆö",
                  wrap: true,
                  size: "sm",
                  color: "#666666",
                  flex: 4,
                },
              ],
            },
          ],
        },
        {
          type: "text",
          text: `${updatedBy || "Á≥ªÁµ±ÈÄöÁü•"}`,
          size: "sm",
          color: "#aaaaaa",
          margin: "xxl",
        },
      ],
    },
    footer: {
      type: "box",
      layout: "vertical",
      spacing: "sm",
      contents: [
        {
          type: "button",
          action: {
            type: "uri",
            label: "Google ÊúÉË≠∞ÈÄ£Áµê",
            uri: url || "https://www.google.com",
          },
          style: "primary",
          color: "#003A8A",
        },
        {
          type: "button",
          action: {
            type: "uri",
            label: "ÂÖßÈÉ®ÊµÅÁ®ã",
            uri: innerPageUrl || "https://www.google.com",
          },
          style: "primary",
          color: "#003A8A",
        },
      ],
    },
  };
}

// Âª∫Á´ãÊ¥ªÂãïË°åÂâçÈÄöÁü•ÁöÑ Flex Message
function createActivityNotificationFlex({
  title = "Ê¥ªÂãïË°åÂâçÈÄöÁü•",
  customerName,
  date,
  location,
  projectType,
  url,
  updatedBy,
  backgroundColor = "#E53935", // Á¥ÖËâ≤
  pageId,
}) {
  return {
    type: "bubble",
    header: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: title,
          color: "#ffffff",
          size: "sm",
          weight: "bold",
        },
      ],
      backgroundColor: backgroundColor,
    },
    body: {
      type: "box",
      layout: "vertical",
      contents: [
        {
          type: "text",
          text: customerName,
          weight: "bold",
          size: "lg",
          wrap: true,
        },
        {
          type: "box",
          layout: "vertical",
          margin: "lg",
          spacing: "sm",
          contents: [
            {
              type: "box",
              layout: "baseline",
              spacing: "sm",
              contents: [
                {
                  type: "text",
                  text: "È°ûÂûã",
                  color: "#aaaaaa",
                  size: "sm",
                  flex: 1,
                },
                {
                  type: "text",
                  text: projectType || "Êú™Ë®≠ÂÆö",
                  wrap: true,
                  size: "sm",
                  color: "#666666",
                  flex: 4,
                },
              ],
            },
            {
              type: "box",
              layout: "baseline",
              spacing: "sm",
              contents: [
                {
                  type: "text",
                  text: "Êó•Êúü",
                  color: "#aaaaaa",
                  size: "sm",
                  flex: 1,
                },
                {
                  type: "text",
                  text: date || "Êú™Ë®≠ÂÆö",
                  wrap: true,
                  size: "sm",
                  color: "#666666",
                  flex: 4,
                },
              ],
            },
            {
              type: "box",
              layout: "baseline",
              spacing: "sm",
              contents: [
                {
                  type: "text",
                  text: "Âú∞Èªû",
                  color: "#aaaaaa",
                  size: "sm",
                  flex: 1,
                },
                {
                  type: "text",
                  text: location || "Êú™Ë®≠ÂÆö",
                  wrap: true,
                  size: "sm",
                  color: "#666666",
                  flex: 4,
                },
              ],
            },
          ],
        },
        {
          type: "text",
          text: `${updatedBy || "Á≥ªÁµ±ÈÄöÁü•"}`,
          size: "sm",
          color: "#aaaaaa",
          margin: "xxl",
        },
      ],
    },
    footer: {
      type: "box",
      layout: "vertical",
      spacing: "sm",
      contents: [
        {
          type: "button",
          action: {
            type: "postback",
            label: "Á¢∫Ë™çÂèÉÂä†",
            data: `action=confirm&pageId=${pageId}`,
            displayText: "ÊàëÁ¢∫Ë™çÂèÉÂä†Ê≠§Ê¥ªÂãï",
          },
          style: "primary",
          color: "#008000",
        },
      ],
    },
  };
}

export {
  sendMessageToLine,
  sendFlexMessageToLine,
  createProjectNotificationFlex,
  createCostNotificationFlex,
  createCostHistoryFlexMessage,
  createInternalPreMeetingNotificationForConfirmFlex,
  createInternalPreMeetingNotificationForMeetAndInternalProcessFlex,
  createActivityNotificationFlex,
  createDuplicateScheduleFlexMessage,
};
